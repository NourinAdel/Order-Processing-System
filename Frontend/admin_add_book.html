<!DOCTYPE html>
<head>
    <title>Book Ordering Website - Add Book</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h3>Enter New Book Information</h3>
    
    <div id="message-container"></div>

    <form id="AddBookForm">
        <label for="isbn">ISBN:</label>
        <input type="text" id="isbn" name="isbn" required><br>

        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required><br>

    <label for="authors">Author(s) (Press Ctrl to select multiple authors):</label>
        <select id="authors" name="authors[]" multiple required style="height: 100px;">
            <option value="">Choose Author(s).</option>
        </select><br>

    <label for="publisher_id">Publisher:</label>
    <select id="publisher_id" name="publisher_id" required>
        <option value="">Choose Publisher</option>
    </select>

        </select><br>
        <label for="year">Publication Year:</label>
        <input type="number" id="year" name="year" min="1000" max="2026" required><br>

        <label for="price">Price:</label>
        <input type="number" id="price" name="price" step="0.01" required><br>

        <label for="category">Category:</label>
        <select id="category" name="category" required>
            <option value="Science">Science</option>
            <option value="Art">Art</option>
            <option value="Religion">Religion</option>
            <option value="History">History</option>
            <option value="Geography">Geography</option>
        </select><br>

        <label for="stock">Initial Stock:</label>
        <input type="number" id="stock" name="stock" value="0" required><br>

        <label for="threshold">Reorder Threshold:</label>
        <input type="number" id="threshold" name="threshold" value="5" required><br>
        
        <br>
        <input type="submit" value="Add Book">
    </form>

    <button onclick="window.location.href = 'adminrole.html'" class="AdminPageButton">Back</button>
    <script>
        const addBookForm = document.getElementById('AddBookForm');
        const messageContainer = document.getElementById('message-container');
        const publisherSelect = document.getElementById('publisher_id');
        const authorSelect = document.getElementById('authors');

        function loadAuthors() {
            fetch('../admin/process_files/process_get_authors.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        authorSelect.innerHTML = '';
                        data.authors.forEach(a => {
                            const option = document.createElement('option');
                            option.value = a.author_id;
                            option.textContent = a.name;
                            authorSelect.appendChild(option);
                        });
                    } else {
                        authorSelect.innerHTML = '<option value="">Error loading authors</option>';
                    }
                })
                .catch(err => {
                    authorSelect.innerHTML = '<option value="">Connection Error</option>';
                    console.error('Fetch error:', err);
                });
        }

        function loadPublishers() {
            fetch('../admin/process_files/process_get_publishers.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        publisherSelect.innerHTML = '<option value="">Select Publisher</option>';
                        data.publishers.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.publisher_id;
                            option.textContent = p.name;
                            publisherSelect.appendChild(option);
                        });
                    } else {
                        publisherSelect.innerHTML = '<option value="">Error loading list</option>';
                        console.error(data.error);
                    }
                })
                .catch(err => {
                    publisherSelect.innerHTML = '<option value="">Connection Error</option>';
                    console.error('Fetch error:', err);
                });
        }

        loadAuthors();
        loadPublishers();

        addBookForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
const stock = parseInt(document.getElementById('stock').value);
    const threshold = parseInt(document.getElementById('threshold').value);

    if (stock < threshold) {
        const proceed = confirm(
            "Initial stock is below the reorder threshold.\n" +
            "A replenishment order will be created automatically.\n\n" +
            "Do you want to continue?"
        );
        if (!proceed) return;
    }

    messageContainer.innerHTML = 'Processing...';
    const formData = new FormData(this);

            fetch('../admin/process_files/process_add_book.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageContainer.innerHTML = `<p style="color: green; font-weight: bold;">${data.message}</p>`;
                    addBookForm.reset(); 
                } else {
                    messageContainer.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageContainer.innerHTML = `<p style="color: red;">Submission Error: Is the database connected?</p>`;
            });
        });
    </script>
</body>
</html>